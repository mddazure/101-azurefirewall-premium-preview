{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
	},
	"variables": {
		"keyVaultName": "[concat('fw-premium-', uniqueString(resourceGroup().id))]",
		"keyVaultSecretName": "cacert",
		"keyVaultCertName": "intermediateCA",
		"keyVaultSecretId": "[concat('https://', variables('keyVaultName'), '.vault.azure.net/secrets/', variables('keyVaultSecretName'))]",
		"keyVaultCertId": "[concat('https://', variables('keyVaultName'), '.vault.azure.net/secrets/', variables('keyVaultCertName'))]",
		"location": "[resourceGroup().location]",
		"policyLocation": "[variables('location')]"
	},
	"resources": [
		{
			"apiVersion": "2020-05-01",
			"type": "Microsoft.Network/firewallPolicies",
			"name": "DemoFirewallPolicy",
			"location": "[variables('policyLocation')]",
			"properties": {
				"sku": {"tier": "Premium"},
				"transportSecurity": {
					"certificateAuthority": {
						"name": "[variables('keyVaultSecretName')]",
						"keyVaultSecretId": "[variables('keyVaultCertId')]"
					}
				},
				"intrusionDetection": {
					"mode": "Alert",
					"configuration": {
						"signatureOverrides": [ 
							{ 
								"id": "2024897",
								"mode": "Deny" 
							}, 
							{
								"id": "2008983", //Blacksun user agent
								"mode": "Deny"

							},
							{
								"id": "2033051", //DNS worldhomeoutlet.com
								"mode": "Deny"
							},
							{ 
								"id": "2024898", 
								"mode": "Alert" 
							} 
						],
						"bypassTrafficSettings": [
							{
								"name": "MyRule",
								"protocol": "TCP",
								"sourceAddresses": [
									"10.0.10.10",
									"10.0.10.11"
								], 
								"destinationAddresses": [
									"1.1.1.1" 
								], 
								"destinationPorts": [
									"80" 
								]
							}
						]
					}
				}				
			},
			"resources": [
				{
					"apiVersion": "2020-05-01",
					"type": "ruleCollectionGroups",
					"name": "DemoPolicyRuleCollectionGroup",
					"location": "[variables('policyLocation')]",
					"dependsOn": [
						"[resourceId('Microsoft.Network/firewallPolicies', 'DemoFirewallPolicy')]"
					],
					"properties": {
						"priority": 200,
						"ruleCollections": [
							{
								"name": "AllowNetwork",
								"priority": 120,
								"ruleCollectionType": "FirewallPolicyFilterRuleCollection",
								"action": {
									"type": "Allow"
								},
								"rules":[
									{
										"ruleType": "NetworkRule",
										"name":"AllowDNS",
										"ipProtocols": [
										"TCP",
										"UDP"
										],
										"destinationAddresses": [
										"8.8.8.8"
										],
										"destinationIpGroups": [],
                                		"destinationFqdns": [],
                                		"destinationPorts": [
                                    	"53"
                                		],
										"sourceAddresses": [
											"*"
										],
										"sourceIpGroups": []
									}
								]
							},
							{
								"name": "DenyApplication",
								"priority": 150,
								"ruleCollectionType": "FirewallPolicyFilterRuleCollection",
								"action": {
									"type": "Deny"
								},
								"rules": [
																		{
										"ruleType": "ApplicationRule",
										"name": "DenyWebCategories",
										"protocols": [
											{
												"protocolType": "Https",
												"port": 443
											},
											{
												"protocolType": "Http",
												"port": 80
											}
										],
					                    "fqdnTags": [],
                                		"webCategories": [
											"Weapons"
										],
                                		"targetUrls":[],
										"targetFqdns": [],
										"sourceAddresses": [
											"*"
										],
                               			"destinationAddresses": [],
                                		"sourceIpGroups": [],
										"terminateTLS": true
									}									
								]							
							},
														
							{
								"name": "AllowApplication",
								"priority": 200,
								"ruleCollectionType": "FirewallPolicyFilterRuleCollection",
								"action": {
									"type": "Allow"
								},
								"rules": [
									{ 
										"ruleType": "ApplicationRule", 
										"name": "AllowWeb", 
										"protocols":[ 
											{ 
												"protocolType":"Https", 
												"port":443 
											}
										],
					                    "fqdnTags": [],
                                		"webCategories": [],
                                		"targetFqdns": [],
										"targetUrls":[ 
											"www.colt.com/*",
											"www.microsoft.com/en-us/surface/devices/surface-duo",
											"azfw-premium-app.azurewebsites.net/index.html"
										],
										"sourceAddresses":[ 
											"*"
										],
                               			"destinationAddresses": [],
                                		"sourceIpGroups": [],
										"terminateTLS":true 
									},
									{
										"ruleType": "ApplicationRule",
										"name": "AllowDemoServer",
										"protocols": [
											{
												"protocolType": "Https",
												"port": 443
											},
											{
												"protocolType": "Http",
												"port": 80
											}
										],
					                    "fqdnTags": [],
                                		"webCategories": [],
                                		"targetUrls":[],
										"targetFqdns": [
											"server.2020-private-preview.com",
											"azfw-premium-app.azurewebsites.net"
										],
										"sourceAddresses": [
											"*"
										],
                               			"destinationAddresses": [],
                                		"sourceIpGroups": [],
										"terminateTLS": true
									}
							]
							}
						]
					}
				}				
			],
			"identity": {
				"type": "UserAssigned",
				"userAssignedIdentities": {
					"[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'DemoIdentity')]": {}
				}
			}
		}
	]
}
